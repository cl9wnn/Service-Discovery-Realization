# Дизайн-документ: Service Discovery и динамическое управления топологией

## Введение 

**Service Discovery** (механизм обнаружения сервисов) позволяет динамически управлять топологией распределенной системы, упрощая маршрутизацию запросов между сервисами.

Данный документ описывает архитектуру системы Service Discovery, функциональные требования и собственную реализацию на базе **Server-Side Discovery Pattern**.
<br><br>

## Архитектура

Система Service Discovery состоит из двух ключевых компонентов:

- **Load Balancer** (Балансировщик нагрузки) – выполняет роль входной точки для пользовательских запросов, распределяя их между доступными экземплярами сервисов.

- **Service Discovery** – управляет регистрацией сервисов и предоставляет Load Balancer-у актуальную информацию о доступных экземплярах.

### 1. Load Balancer

Функциональные требования:
- Принимает входящие HTTP-запросы от клиентов.
- Запрашивает актуальный список зарегистрированных сервисов у Service Discovery.
- Выбирает подходящий экземпляр сервиса для обработки запроса (например, с использованием алгоритма Round-Robin).
- Проксирует запрос к выбранному сервису и передает клиенту его ответ.

Минимальная реализация:
- Реализация HTTP-прокси-сервера на HttpListener или Kestrel.
- Простая маршрутизация запросов с учетом доступных сервисов.
- Поддержка динамического обновления списка сервисов.


### 2. Service Discovery

Функциональные требования:
- Хранит список активных сервисов в памяти.
- Обеспечивает механизмы регистрации и удаления сервисов.
- Поддерживает механизм heartbeat, позволяющий исключать недоступные сервисы.

Предоставляет API для управления сервисами:
- POST /register – регистрация нового экземпляра сервиса.
- POST /heartbeat – обновление информации о состоянии сервиса.
- GET /services – получение списка активных сервисов.
- DELETE /unregister – удаление сервиса из реестра.

Минимальная реализация:
- Хранение информации о инстансах в Dictionary.
- Сервер на HttpListener или Kestrel.
- Фоновый процесс, проверяющий доступность сервисов по тайм-ауту.
- Удаление сервисов, не отправивших heartbeat в течение заданного времени.

Полная реализация (Дополнительно к минимальной):
- Использование In-Memory БД для хранения информации
- Дополнительная проверка сервиса после перед окончательным добавлением в пул
- Автообнаружение сервисов в выделенной сети c помощью сокетов и multicast вещания.
